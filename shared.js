

// Translations
const TRANSLATIONS = {
    en: {
        reviewHistory: "Review History",
        sessionHistory: "Session History",
        noHistory: "No questions answered yet.",
        newSession: "New Session",
        clickDrop: "Click column to drop.",
        soloTitle: "Solo Quiz",
        soloDesc: "Focus on accuracy.",
        resume: "Resume Quiz",
        nextPrize: "Next Prize",
        currentQ: "Current Question",
        revealQ: "Reveal Question",
        ladder: "Career Ladder",
        config: "Configuration",
        mode: "Mode",
        mSolo: "Solo",
        mQuiz: "Quiz",
        mConnect: "Connect 4",
        mStrategy: "Strategy",
        mResidency: "Residency",
        mHighStakes: "High Stakes",
        mPoints: "Points Battle",
        mCompetitive: "Competitive",
        topic: "Topic",
        tMixed: "All Topics",
        tDerma: "Derma",
        tPatho: "Patho",
        tRiddles: "Riddles",
        seerah: "Seerah",
        aqidah: "Aqidah",
        progress: "Bank Progress",
        resetHist: "Reset History",
        questions: "Questions",
        teams: "Teams",
        gridWidth: "Grid Width",
        startGame: "Start Game",
        startQuiz: "Start Quiz",
        beginRes: "Begin Residency",
        beginBattle: "Begin Battle",
        loading: "Loading...",
        lVitals: "Vitals",
        lConsult: "Consult",
        finishEarly: "Finish Early",
        mistakes: "Mistakes",
        flagged: "Flagged",
        fAll: "All",
        clearList: "Clear List",
        playAgain: "Play Again",
        correct: "Correct!",
        wrong: "Wrong!",
        goodJob: "Good Job!",
        answerRevealed: "Answer Revealed",
        correctAnswer: "The correct answer is:",
        yourAnswer: "Your Answer:",
        nextQuestion: "Next Question",
        continueClimb: "Continue Climbing",
        seeResults: "See Results",
        dropPiece: "Drop Piece",
        endTurn: "End Turn",
        stealChance: "Steal Chance!",
        attemptSteal: "Attempt Steal",
        passTurn: "Pass Turn",
        points: "Points",
        diffEasy: "Easy (100)",
        diffMed: "Medium (150)",
        diffHard: "Hard (200)",
        remainingQ: "Remaining:",
        giveUp: "I give up, show me the answer",
        submit: "Submit Answer",
        typeAnswer: "Type your answer here...",
        victory: "VICTORY!",
        completed: "COMPLETED!",
        eliminated: "ELIMINATED!",
        youWin: "Wins!",
        score: "Score",
        noItems: "No items found.",
        sessionFinished: "Session finished.",
        topRank: "You reached the top rank!",
        walkAway: "You walk away with...",
        pickTopic: "Select a Topic",
        reportQ: "Report Question",
        reported: "Reported"
    },
    ar: {
        reviewHistory: "سجل المراجعة",
        sessionHistory: "سجل الجلسة",
        noHistory: "لم يتم الإجابة على أي سؤال بعد.",
        newSession: "جلسة جديدة",
        clickDrop: "انقر على العمود للإسقاط.",
        soloTitle: "اختبار فردي",
        soloDesc: "ركز على الدقة.",
        resume: "استكمال الاختبار",
        nextPrize: "الجائزة التالية",
        currentQ: "السؤال الحالي",
        revealQ: "كشف السؤال",
        ladder: "سلم المسار المهني",
        config: "الإعدادات",
        mode: "النمط",
        mSolo: "فردي",
        mQuiz: "اختبار",
        mConnect: "توصيل 4",
        mStrategy: "استراتيجية",
        mResidency: "الإقامة",
        mHighStakes: "تحدي عالي",
        mPoints: "معركة النقاط",
        mCompetitive: "تنافسي",
        topic: "الموضوع",
        tMixed: "كل المواضيع",
        tDerma: "جلدية",
        tPatho: "باثولوجي",
        tRiddles: "أحجيات",
        seerah: "السيرة",
        aqidah: "العقيدة",
        progress: "تقدم البنك",
        resetHist: "إعادة تعيين",
        questions: "الأسئلة",
        teams: "الفرق",
        gridWidth: "عرض الشبكة",
        startGame: "ابدأ اللعبة",
        startQuiz: "ابدأ الاختبار",
        beginRes: "ابدأ الإقامة",
        beginBattle: "ابدأ المعركة",
        loading: "جار التحميل...",
        lVitals: "العلامات الحيوية",
        lConsult: "استشارة",
        finishEarly: "إنهاء مبكر",
        mistakes: "أخطاء",
        flagged: "محفوظة",
        fAll: "الكل",
        clearList: "مسح القائمة",
        playAgain: "العب مرة أخرى",
        correct: "صحيح!",
        wrong: "خطأ!",
        goodJob: "أحسنت!",
        answerRevealed: "تم كشف الإجابة",
        correctAnswer: "الإجابة الصحيحة هي:",
        yourAnswer: "إجابتك:",
        nextQuestion: "السؤال التالي",
        continueClimb: "تابع الصعود",
        seeResults: "النتائج",
        dropPiece: "إسقاط القطعة",
        endTurn: "إنهاء الدور",
        stealChance: "فرصة للسرقة!",
        attemptSteal: "حاول السرقة",
        passTurn: "تخطى الدور",
        points: "النقاط",
        diffEasy: "سهل (100)",
        diffMed: "متوسط (150)",
        diffHard: "صعب (200)",
        remainingQ: "المتبقي:",
        giveUp: "استسلم، أرني الإجابة",
        submit: "إرسال الإجابة",
        typeAnswer: "اكتب إجابتك هنا...",
        victory: "انتصار!",
        completed: "مكتمل!",
        eliminated: "تم الإقصاء!",
        youWin: "فاز!",
        score: "النتيجة",
        noItems: "لا توجد عناصر.",
        sessionFinished: "انتهت الجلسة.",
        topRank: "لقد وصلت إلى أعلى رتبة!",
        walkAway: "لقد ربحت...",
        pickTopic: "يرجى اختيار موضوع",
        reportQ: "إبلاغ عن السؤال",
        reported: "تم الإبلاغ"
    }
};

const PLAYERS_CONFIG = [
    { id: 1, name: "Red", colorClass: "bg-red-500", ringClass: "ring-red-500", textClass: "text-red-500", bgLight: "bg-red-100", bgDark: "bg-red-900/30" },
    { id: 2, name: "Yellow", colorClass: "bg-yellow-400", ringClass: "ring-yellow-400", textClass: "text-yellow-400", bgLight: "bg-yellow-100", bgDark: "bg-yellow-900/30" },
    { id: 3, name: "Green", colorClass: "bg-green-500", ringClass: "ring-green-500", textClass: "text-green-500", bgLight: "bg-green-100", bgDark: "bg-green-900/30" },
    { id: 4, name: "Purple", colorClass: "bg-purple-500", ringClass: "ring-purple-500", textClass: "text-purple-500", bgLight: "bg-purple-100", bgDark: "bg-purple-900/30" },
    { id: 5, name: "Cyan", colorClass: "bg-cyan-400", ringClass: "ring-cyan-400", textClass: "text-cyan-400", bgLight: "bg-cyan-100", bgDark: "bg-cyan-900/30" },
    { id: 6, name: "Orange", colorClass: "bg-orange-500", ringClass: "ring-orange-500", textClass: "text-orange-500", bgLight: "bg-orange-100", bgDark: "bg-orange-900/30" }
];

const LADDER = [
    { val: 100, safe: false }, { val: 200, safe: false }, { val: 300, safe: false },
    { val: 500, safe: true },
    { val: 1000, safe: false }, { val: 2000, safe: false }, { val: 4000, safe: false },
    { val: 8000, safe: true },
    { val: 16000, safe: false }, { val: 32000, safe: false }, { val: 64000, safe: false },
    { val: 125000, safe: true },
    { val: 250000, safe: false }, { val: 500000, safe: false }, { val: 1000000, safe: true }
];

const ROWS = 10;

// SHARED STATE
let state = {
    lang: 'en',
    category: 'all', // 'general' or 'educational' or 'all'
    gameMode: null, // Initialize as null to detect first load vs replay
    activePlayersCount: null,
    activeColCount: null,
    selectedTopics: [], // Start empty, user must select
    questionLimit: null,
    currentPlayerIndex: 0,
    board: [],
    playerScores: {},
    soloScore: 0,
    soloTotal: 0,
    gameActive: false,
    questionQueue: [],
    pendingColumn: null,
    isSidebarOpen: true,
    history: [],
    currentQuestion: null,
    currentResult: null,
    currentSelection: null,
    ladderIndex: 0,
    lifelines: { '5050': true, 'poll': true, 'consult': true },
    safeAmount: 0,
    reviewTab: 'mistakes',
    reviewFilter: 'all',
    
    // Points Battle Specific
    pointsBattleTotalQ: 30,
    pointsBattleRemaining: 30,
    currentDifficultyValue: 0,
    isStealMode: false,
    stealingPlayerIndex: -1
};

function getText(key) {
    return TRANSLATIONS[state.lang][key] || TRANSLATIONS['en'][key] || key;
}

// --- PERSISTENCE LOGIC ---
const STORAGE_KEY_SOLVED = 'medconnect_solved_ids';
const STORAGE_KEY_MISTAKES = 'medconnect_mistakes';
const STORAGE_KEY_FLAGGED = 'medconnect_flagged';

function getScopedKey(baseKey) {
    return `${baseKey}_${state.lang || 'en'}`;
}

function getSolvedIDs() {
    const stored = localStorage.getItem(getScopedKey(STORAGE_KEY_SOLVED));
    return stored ? JSON.parse(stored) : [];
}

function markQuestionSolved(id) {
    const solved = getSolvedIDs();
    if (!solved.includes(id)) {
        solved.push(id);
        localStorage.setItem(getScopedKey(STORAGE_KEY_SOLVED), JSON.stringify(solved));
    }
}

function resetProgress() {
    if(confirm("Are you sure you want to reset your learning progress?")) {
        localStorage.removeItem(getScopedKey(STORAGE_KEY_SOLVED));
        if (typeof updateBankStats === 'function') {
            updateBankStats();
        }
    }
}

// --- MISTAKES HISTORY ---
function saveMistake(question, userAnswerIdx, topic) {
    const mistakes = getMistakes();
    const today = new Date().toISOString().split('T')[0];
    const entry = {
        id: question.id,
        q: question,
        userIdx: userAnswerIdx,
        date: today,
        timestamp: Date.now(),
        topic: topic
    };
    mistakes.unshift(entry); 
    if (mistakes.length > 200) mistakes.pop();
    localStorage.setItem(getScopedKey(STORAGE_KEY_MISTAKES), JSON.stringify(mistakes));
}

function getMistakes() {
    const stored = localStorage.getItem(getScopedKey(STORAGE_KEY_MISTAKES));
    return stored ? JSON.parse(stored) : [];
}

function clearMistakes(filter = 'all') {
    let msg = "Clear all mistake history?";
    if(filter !== 'all') msg = `Clear ${filter.toUpperCase()} mistake history?`;
    
    if(confirm(msg)) {
        if(filter === 'all') {
            localStorage.removeItem(getScopedKey(STORAGE_KEY_MISTAKES));
        } else {
            let mistakes = getMistakes();
            mistakes = mistakes.filter(m => {
                let t = m.topic || '';
                if(!t && m.q && m.q.id) {
                    if(m.q.id.startsWith('dermatology')) t = 'derma';
                    else if (m.q.id.startsWith('clinical')) t = 'patho';
                    else if (m.q.id.startsWith('riddles')) t = 'riddles';
                    else if (m.q.id.startsWith('geo')) t = 'geography';
                    else if (m.q.id.startsWith('seerah')) t = 'seerah';
                    else if (m.q.id.startsWith('aqidah')) t = 'aqidah';
                    else if (m.q.id.startsWith('surgery')) t = 'surgery';
                }
                return t !== filter;
            });
            localStorage.setItem(getScopedKey(STORAGE_KEY_MISTAKES), JSON.stringify(mistakes));
        }
        return true;
    }
    return false;
}

// --- FLAGGED QUESTIONS ---
function toggleFlagQuestion(question, topic) {
    let flagged = getFlagged();
    const existingIndex = flagged.findIndex(f => f.id === question.id);
    
    if (existingIndex > -1) {
        flagged.splice(existingIndex, 1); // Remove
    } else {
        flagged.unshift({
            id: question.id,
            q: question,
            date: new Date().toISOString().split('T')[0],
            topic: topic
        });
    }
    localStorage.setItem(getScopedKey(STORAGE_KEY_FLAGGED), JSON.stringify(flagged));
    return existingIndex === -1;
}

function isQuestionFlagged(id) {
    const flagged = getFlagged();
    return flagged.some(f => f.id === id);
}

function getFlagged() {
    const stored = localStorage.getItem(getScopedKey(STORAGE_KEY_FLAGGED));
    return stored ? JSON.parse(stored) : [];
}

function clearFlagged(filter = 'all') {
    let msg = "Clear all flagged questions?";
    if(filter !== 'all') msg = `Clear ${filter.toUpperCase()} flagged questions?`;

    if(confirm(msg)) {
        if(filter === 'all') {
            localStorage.removeItem(getScopedKey(STORAGE_KEY_FLAGGED));
        } else {
            let flagged = getFlagged();
            flagged = flagged.filter(f => {
                let t = f.topic || '';
                if(!t && f.q && f.q.id) {
                    if(f.q.id.startsWith('dermatology')) t = 'derma';
                    else if (f.q.id.startsWith('clinical')) t = 'patho';
                    else if (f.q.id.startsWith('riddles')) t = 'riddles';
                    else if (f.q.id.startsWith('geo')) t = 'geography';
                    else if (f.q.id.startsWith('seerah')) t = 'seerah';
                    else if (f.q.id.startsWith('aqidah')) t = 'aqidah';
                    else if (f.q.id.startsWith('surgery')) t = 'surgery';
                }
                return t !== filter;
            });
            localStorage.setItem(getScopedKey(STORAGE_KEY_FLAGGED), JSON.stringify(flagged));
        }
        return true;
    }
    return false;
}